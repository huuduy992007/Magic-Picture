<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nguy·ªÖn H·ªØu Duy - AI Image Transform</title>
    <!-- T·∫£i Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- C·∫•u h√¨nh Tailwind cho font Inter v√† m√†u s·∫Øc -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#4F46E5', // Indigo
                        'secondary': '#10B981', // Emerald
                        'background': '#F9FAFB', // Light Gray background
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');

        /* ·∫®n input file m·∫∑c ƒë·ªãnh v√† t√πy ch·ªânh button */
        #fileInput {
            display: none;
        }

        /* T√πy ch·ªânh thanh cu·ªôn cho khu v·ª±c hi·ªÉn th·ªã ·∫£nh (t√πy ch·ªçn) */
        .image-container {
            min-height: 256px;
        }

        /* Custom scrollbar */
        .theme-select::-webkit-scrollbar {
            width: 8px;
        }

        .theme-select::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .theme-select::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .theme-select::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>

<body class="bg-background min-h-screen font-sans antialiased p-4 sm:p-8">

    <!-- Container Ch√≠nh -->
    <div class="max-w-4xl mx-auto bg-white shadow-2xl rounded-xl p-6 sm:p-10">

        <!-- Ti√™u ƒë·ªÅ v√† H∆∞·ªõng d·∫´n -->
        <header class="text-center mb-10">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-900 mb-2">
                üé® Bi·∫øn ƒê·ªïi ·∫¢nh C·ªßa B·∫°n V·ªõi AI
            </h1>
            <p class="text-gray-600 text-lg">
                T·∫£i l√™n ·∫£nh v√† ch·ªçn ch·ªß ƒë·ªÅ. Gemini AI s·∫Ω t·∫°o ra m·ªôt t√°c ph·∫©m ngh·ªá thu·∫≠t m·ªõi!
            </p>
        </header>

        <!-- Khu v·ª±c 1: T·∫£i ·∫£nh v√† L·ª±a ch·ªçn ch·ªß ƒë·ªÅ -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-10">

            <!-- T·∫£i ·∫£nh l√™n -->
            <div
                class="border-2 border-dashed border-gray-300 rounded-lg p-6 flex flex-col items-center justify-center space-y-4 hover:border-primary transition duration-300">
                <label for="fileInput"
                    class="cursor-pointer bg-primary text-white py-3 px-6 rounded-full font-semibold shadow-lg hover:bg-indigo-600 transition duration-300">
                    Ch·ªçn ·∫¢nh T·∫£i L√™n
                </label>
                <input type="file" id="fileInput" accept="image/*">
                <p class="text-sm text-gray-500">T·∫£i l√™n ·∫£nh ƒë·ªãnh d·∫°ng JPG, JPEG ho·∫∑c PNG (t·ªëi ƒëa 5MB).</p>

                <!-- Xem tr∆∞·ªõc ·∫£nh g·ªëc -->
                <div id="originalImageContainer"
                    class="mt-4 w-full max-h-64 overflow-hidden rounded-lg border border-gray-200"
                    style="display: none;">
                    <img id="originalImage" class="w-full h-auto object-contain max-h-64" alt="·∫¢nh g·ªëc">
                </div>
            </div>

            <!-- L·ª±a ch·ªçn ch·ªß ƒë·ªÅ -->
            <div class="space-y-4">
                <label for="themeSelector" class="block text-xl font-bold text-gray-800">2. Ch·ªçn Ch·ªß ƒê·ªÅ Bi·∫øn
                    ƒê·ªïi:</label>
                <select id="themeSelector"
                    class="theme-select w-full p-3 border-2 border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition duration-300 text-gray-700 bg-white shadow-sm">
                    <option value="" disabled selected>-- Ch·ªçn m·ªôt phong c√°ch --</option>
                    <option
                        value="Bi·∫øn ƒë·ªïi ho√†n to√†n th√†nh phong c√°ch Gi√°ng Sinh ·∫•m √°p, ƒë·∫ßy tuy·∫øt v√† √°nh ƒë√®n lung linh.">
                        Gi√°ng Sinh üéÑ</option>
                    <option
                        value="Bi·∫øn ƒë·ªïi ho√†n to√†n th√†nh phong c√°ch Halloween ma qu√°i, r√πng r·ª£n v·ªõi b√≠ ng√¥ v√† m√†u t·ªëi.">
                        Halloween üéÉ</option>
                    <option
                        value="Bi·∫øn ƒë·ªïi ho√†n to√†n th√†nh phong c√°ch T·∫øt Nguy√™n ƒê√°n r·ª±c r·ª°, v·ªõi hoa mai, hoa ƒë√†o, v√† kh√¥ng kh√≠ l·ªÖ h·ªôi truy·ªÅn th·ªëng.">
                        T·∫øt Nguy√™n ƒê√°n üßß</option>
                    <option
                        value="Bi·∫øn ƒë·ªïi ho√†n to√†n th√†nh phong c√°ch L·ªÖ h·ªôi M√πa H√® r·ª±c r·ª°, ƒë·∫ßy m√†u s·∫Øc, ph√°o hoa v√† √¢m nh·∫°c.">
                        L·ªÖ h·ªôi M√πa H√® üéÜ</option>
                    <option
                        value="Bi·∫øn ƒë·ªïi ho√†n to√†n th√†nh m·ªôt b·ª©c tranh phong c·∫£nh M√πa Thu l√£ng m·∫°n, v·ªõi l√° v√†ng, l√° ƒë·ªè.">
                        Phong c·∫£nh M√πa Thu üçÇ</option>
                    <option
                        value="Bi·∫øn ƒë·ªïi ho√†n to√†n th√†nh m·ªôt b·ª©c tranh phong c·∫£nh M√πa Xu√¢n t∆∞∆°i m·ªõi, v·ªõi c√¢y c·ªëi ƒë√¢m ch·ªìi n·∫£y l·ªôc v√† hoa n·ªü.">
                        Phong c·∫£nh M√πa Xu√¢n üå∏</option>
                    <option
                        value="Bi·∫øn ƒë·ªïi ho√†n to√†n th√†nh phong c√°ch thi·ªáp Ch√∫c M·ª´ng Sinh Nh·∫≠t, vui t∆∞∆°i v√† ƒë·∫ßy qu√† t·∫∑ng.">
                        Sinh Nh·∫≠t üéÇ</option>
                    <option
                        value="Bi·∫øn ƒë·ªïi ho√†n to√†n th√†nh phong c√°ch tranh s∆°n d·∫ßu tr·ª´u t∆∞·ª£ng, ƒë·∫ßy m√†u s·∫Øc v√† ƒë∆∞·ªùng n√©t m·∫°nh m·∫Ω.">
                        Tranh S∆°n D·∫ßu Tr·ª´u T∆∞·ª£ng üé®</option>
                    <option
                        value="Bi·∫øn ƒë·ªïi ho√†n to√†n th√†nh phong c√°ch ho·∫°t h√¨nh Nh·∫≠t B·∫£n (Anime) l√£ng m·∫°n, v·ªõi m√†u s·∫Øc t∆∞∆°i s√°ng v√† m·∫Øt to.">
                        Phong c√°ch Anime üéå</option>
                </select>

                <!-- API Key Input (C√≥ th·ªÉ ·∫©n ƒëi n·∫øu kh√¥ng mu·ªën hi·ªÉn th·ªã) -->
                <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd"
                                    d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"
                                    clip-rule="evenodd" />
                            </svg>
                        </div>
                        <div class="ml-3">
                            <label for="apiKey" class="block text-sm font-medium text-gray-700 mb-1">
                                üîë Nh·∫≠p API Key c·ªßa b·∫°n:
                            </label>
                            <input type="password" id="apiKey" placeholder="Nh·∫≠p Gemini API Key c·ªßa b·∫°n"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary sm:text-sm">
                            <p class="mt-1 text-sm text-gray-600">
                                L·∫•y API key t·ª´ <a href="https://makersuite.google.com/app/apikey" target="_blank"
                                    class="text-primary hover:underline">Google AI Studio</a>
                            </p>
                        </div>
                    </div>
                </div>

                <!-- N√∫t X·ª≠ l√Ω -->
                <button id="generateButton"
                    class="w-full py-4 px-6 bg-secondary text-white font-bold rounded-xl shadow-xl hover:bg-emerald-600 transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center space-x-2">
                    <svg id="generateIcon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                        xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M11.05 15.54L10 13l-1.05 2.54M21 12a9 9 0 11-18 0 9 9 0 0118 0zM12 21a9 9 0 01-9-9 9 9 0 019-9 9 9 0 019 9 9 9 0 01-9 9zM12 12h.01">
                        </path>
                    </svg>
                    <span id="generateText">T·∫°o ·∫¢nh Bi·∫øn ƒê·ªïi</span>
                    <svg id="loadingSpinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white"
                        xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" style="display: none;">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4">
                        </circle>
                        <path class="opacity-75" fill="currentColor"
                            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                        </path>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Khu v·ª±c 2: Hi·ªÉn th·ªã k·∫øt qu·∫£ v√† T·∫£i v·ªÅ -->
        <div class="border-t border-gray-200 pt-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">3. K·∫øt Qu·∫£ Bi·∫øn ƒê·ªïi</h2>

            <!-- Hi·ªÉn th·ªã th√¥ng b√°o/loading -->
            <div id="messageBox" class="text-center p-4 bg-blue-100 text-blue-800 rounded-lg mb-4"
                style="display: none;">
                ·∫¢nh ƒë√£ s·∫µn s√†ng.
            </div>

            <!-- Container cho ·∫£nh k·∫øt qu·∫£ -->
            <div
                class="image-container w-full bg-gray-100 rounded-lg flex items-center justify-center p-4 shadow-inner">
                <img id="transformedImage" class="max-w-full h-auto max-h-96 rounded-lg shadow-xl" src=""
                    alt="·∫¢nh ƒë√£ chuy·ªÉn ƒë·ªïi" style="display: none;">
                <p id="placeholderText" class="text-gray-500 italic">
                    ·∫¢nh k·∫øt qu·∫£ s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y sau khi b·∫°n t·∫°o.
                </p>
            </div>

            <!-- N√∫t T·∫£i v·ªÅ -->
            <div class="text-center mt-6">
                <button id="downloadButton"
                    class="py-3 px-8 bg-primary text-white font-bold rounded-full shadow-lg hover:bg-indigo-600 transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed">
                    T·∫£i ·∫¢nh V·ªÅ
                </button>
            </div>
        </div>

        <!-- Footer v·ªõi th√¥ng tin -->
        <footer class="mt-10 pt-6 border-t border-gray-200 text-center text-sm text-gray-500">
            <p>Trang web ƒë∆∞·ª£c t·∫°o b·ªüi Nguy·ªÖn H·ªØu Duy.</p>
            <!-- <p class="mt-1">C·∫ßn API key? Truy c·∫≠p <a href="https://makersuite.google.com/app/apikey" target="_blank"
                    class="text-primary hover:underline">Google AI Studio</a> ƒë·ªÉ t·∫°o mi·ªÖn ph√≠.</p> -->
        </footer>

    </div>

    <script>
        // ========== C·∫§U H√åNH ==========
        const GEMINI_MODEL = 'gemini-1.5-flash'; // C√≥ th·ªÉ ƒë·ªïi th√†nh 'gemini-pro' ho·∫∑c 'gemini-1.5-pro'
        const GEMINI_API_BASE = 'https://generativelanguage.googleapis.com/v1beta/models';
        
        // ========== BI·∫æN TO√ÄN C·ª§C ==========
        let base64Image = null;
        let currentTransformedImageUrl = null;
        let currentApiKey = '';

        // ========== KH·ªûI T·∫†O ==========
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Frontend ƒë√£ s·∫µn s√†ng');
            
            // G√°n s·ª± ki·ªán
            document.getElementById('fileInput').addEventListener('change', previewImage);
            document.getElementById('themeSelector').addEventListener('change', checkReadyToGenerate);
            document.getElementById('apiKey').addEventListener('input', checkReadyToGenerate);
            document.getElementById('generateButton').addEventListener('click', generateTransformedImage);
            document.getElementById('downloadButton').addEventListener('click', downloadImage);
            
            // Ki·ªÉm tra xem c√≥ l∆∞u API key trong localStorage kh√¥ng
            const savedApiKey = localStorage.getItem('gemini_api_key');
            if (savedApiKey) {
                document.getElementById('apiKey').value = savedApiKey;
                currentApiKey = savedApiKey;
                checkReadyToGenerate();
                showMessage("ƒê√£ t·∫£i API key t·ª´ b·ªô nh·ªõ. B·∫°n c√≥ th·ªÉ b·∫Øt ƒë·∫ßu s·ª≠ d·ª•ng!", 'bg-green-100 text-green-800');
            }
        });

        // ========== X·ª¨ L√ù FILE UPLOAD ==========
        function previewImage(event) {
            const file = event.target.files[0];
            const originalImage = document.getElementById('originalImage');
            const originalImageContainer = document.getElementById('originalImageContainer');
            const generateButton = document.getElementById('generateButton');

            base64Image = null;

            if (file) {
                // Ki·ªÉm tra k√≠ch th∆∞·ªõc file (max 5MB ƒë·ªÉ tr√°nh l·ªói)
                if (file.size > 5 * 1024 * 1024) {
                    showMessage("‚ö†Ô∏è ·∫¢nh qu√° l·ªõn! Vui l√≤ng ch·ªçn ·∫£nh d∆∞·ªõi 5MB.", 'bg-red-100 text-red-800');
                    event.target.value = '';
                    return;
                }

                // Ki·ªÉm tra ƒë·ªãnh d·∫°ng
                const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];
                if (!validTypes.includes(file.type)) {
                    showMessage("‚ùå Ch·ªâ ch·∫•p nh·∫≠n ·∫£nh JPG, JPEG ho·∫∑c PNG.", 'bg-red-100 text-red-800');
                    event.target.value = '';
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    originalImage.src = e.target.result;
                    originalImageContainer.style.display = 'block';

                    // L·∫•y Base64 data
                    const base64Data = e.target.result.split(',')[1];
                    const mimeType = file.type;

                    if (base64Data) {
                        base64Image = {
                            mimeType: mimeType,
                            data: base64Data,
                            fileName: file.name
                        };
                        checkReadyToGenerate();
                        showMessage("‚úÖ ƒê√£ t·∫£i ·∫£nh th√†nh c√¥ng! Ch·ªçn ch·ªß ƒë·ªÅ v√† nh·∫≠p API key ƒë·ªÉ ti·∫øp t·ª•c.", 'bg-green-100 text-green-800');
                    }
                };
                reader.onerror = function() {
                    showMessage("‚ùå L·ªói khi ƒë·ªçc file. Vui l√≤ng th·ª≠ l·∫°i.", 'bg-red-100 text-red-800');
                };
                reader.readAsDataURL(file);
            } else {
                originalImage.src = '';
                originalImageContainer.style.display = 'none';
                generateButton.disabled = true;
                showMessage("", 'bg-blue-100 text-blue-800');
            }
        }

        // ========== KI·ªÇM TRA ƒêI·ªÄU KI·ªÜN ==========
        function checkReadyToGenerate() {
            const theme = document.getElementById('themeSelector').value;
            const apiKeyInput = document.getElementById('apiKey').value;
            const generateButton = document.getElementById('generateButton');
            
            // L∆∞u API key v√†o bi·∫øn v√† localStorage
            if (apiKeyInput && apiKeyInput !== currentApiKey) {
                currentApiKey = apiKeyInput;
                localStorage.setItem('gemini_api_key', apiKeyInput);
            }
            
            if (base64Image && theme && currentApiKey) {
                generateButton.disabled = false;
                generateButton.classList.remove('disabled:opacity-50', 'disabled:cursor-not-allowed');
            } else {
                generateButton.disabled = true;
                generateButton.classList.add('disabled:opacity-50', 'disabled:cursor-not-allowed');
            }
        }

        // ========== HI·ªÇN TH·ªä TH√îNG B√ÅO ==========
        function showMessage(message, classes = 'bg-blue-100 text-blue-800') {
            const box = document.getElementById('messageBox');
            if (!box) return;
            
            box.textContent = message;
            box.className = `text-center p-4 rounded-lg mb-4 ${classes}`;
            box.style.display = message ? 'block' : 'none';
            
            // T·ª± ƒë·ªông ·∫©n th√¥ng b√°o sau 5 gi√¢y (tr·ª´ l·ªói)
            if (message && !classes.includes('red')) {
                setTimeout(() => {
                    if (box.textContent === message) {
                        box.style.display = 'none';
                    }
                }, 5000);
            }
        }

        // ========== X·ª¨ L√ù LOADING ==========
        function setLoading(isLoading) {
            const generateButton = document.getElementById('generateButton');
            const generateText = document.getElementById('generateText');
            const generateIcon = document.getElementById('generateIcon');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const downloadButton = document.getElementById('downloadButton');

            if (isLoading) {
                // B·∫Øt ƒë·∫ßu loading
                generateButton.disabled = true;
                generateText.textContent = 'ƒêang X·ª≠ L√Ω...';
                generateIcon.style.display = 'none';
                loadingSpinner.style.display = 'inline-block';
                downloadButton.disabled = true;
                showMessage("‚è≥ ƒêang g·ª≠i y√™u c·∫ßu ƒë·∫øn Gemini AI... Qu√° tr√¨nh c√≥ th·ªÉ m·∫•t 15-30 gi√¢y.", 'bg-yellow-100 text-yellow-800');
            } else {
                // K·∫øt th√∫c loading
                generateText.textContent = 'T·∫°o ·∫¢nh Bi·∫øn ƒê·ªïi';
                generateIcon.style.display = 'inline-block';
                loadingSpinner.style.display = 'none';
                checkReadyToGenerate();
            }
        }

        // ========== G·ª¨I Y√äU C·∫¶U ƒê·∫æN GEMINI API ==========
        async function generateTransformedImage() {
            if (!base64Image) {
                showMessage("‚ùå Vui l√≤ng t·∫£i l√™n ·∫£nh tr∆∞·ªõc.", 'bg-red-100 text-red-800');
                return;
            }

            const themePrompt = document.getElementById('themeSelector').value;
            if (!themePrompt) {
                showMessage("‚ùå Vui l√≤ng ch·ªçn ch·ªß ƒë·ªÅ.", 'bg-red-100 text-red-800');
                return;
            }

            if (!currentApiKey) {
                showMessage("‚ùå Vui l√≤ng nh·∫≠p API key c·ªßa b·∫°n.", 'bg-red-100 text-red-800');
                return;
            }

            setLoading(true);
            
            // Reset ·∫£nh c≈©
            const transformedImage = document.getElementById('transformedImage');
            const placeholderText = document.getElementById('placeholderText');
            transformedImage.style.display = 'none';
            placeholderText.style.display = 'block';
            document.getElementById('downloadButton').disabled = true;
            
            // X√≥a URL c≈© n·∫øu c√≥
            if (currentTransformedImageUrl) {
                URL.revokeObjectURL(currentTransformedImageUrl);
                currentTransformedImageUrl = null;
            }

            try {
                console.log('üîÑ ƒêang g·ª≠i request ƒë·∫øn Gemini API...');
                
                // Prompt t·ªëi ∆∞u cho Gemini
                const userPrompt = `B·∫°n l√† m·ªôt ngh·ªá sƒ© AI chuy√™n nghi·ªáp. H√£y bi·∫øn ƒë·ªïi ho√†n to√†n ·∫£nh n√†y theo phong c√°ch sau: ${themePrompt}
                
                Y√äU C·∫¶U:
                1. Gi·ªØ nguy√™n b·ªë c·ª•c ch√≠nh v√† ch·ªß th·ªÉ c·ªßa ·∫£nh g·ªëc
                2. √Åp d·ª•ng phong c√°ch m·ªõi m·ªôt c√°ch tri·ªát ƒë·ªÉ v√† s√°ng t·∫°o
                3. ƒê·∫£m b·∫£o ch·∫•t l∆∞·ª£ng h√¨nh ·∫£nh cao, chi ti·∫øt r√µ r√†ng
                4. Kh√¥ng th√™m watermark, ch·ªØ k√Ω hay text
                5. T·∫°o ra m·ªôt t√°c ph·∫©m ngh·ªá thu·∫≠t ƒë·ªôc ƒë√°o v√† ƒë·∫πp m·∫Øt
                
                H√£y t·∫°o ra h√¨nh ·∫£nh bi·∫øn ƒë·ªïi v·ªõi ch·∫•t l∆∞·ª£ng cao nh·∫•t c√≥ th·ªÉ.`;

                const apiUrl = `${GEMINI_API_BASE}/${GEMINI_MODEL}:generateContent?key=${currentApiKey}`;
                
                const payload = {
                    contents: [{
                        parts: [
                            { text: userPrompt },
                            { 
                                inlineData: {
                                    mimeType: base64Image.mimeType,
                                    data: base64Image.data
                                }
                            }
                        ]
                    }],
                    generationConfig: {
                        temperature: 0.7,
                        topP: 0.8,
                        topK: 40,
                        maxOutputTokens: 2048
                    }
                };

                console.log('üì§ G·ª≠i payload ƒë·∫øn:', apiUrl);
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });

                console.log(`üìä Response status: ${response.status}`);
                
                // X·ª≠ l√Ω response
                if (!response.ok) {
                    const errorText = await response.text();
                    let errorMessage = `L·ªói ${response.status}: ${errorText.substring(0, 200)}`;
                    
                    // X·ª≠ l√Ω c√°c l·ªói ph·ªï bi·∫øn
                    if (response.status === 400) {
                        errorMessage = "L·ªói request. Ki·ªÉm tra l·∫°i API key v√† ƒë·ªãnh d·∫°ng ·∫£nh.";
                    } else if (response.status === 403) {
                        errorMessage = "API key kh√¥ng h·ª£p l·ªá ho·∫∑c kh√¥ng c√≥ quy·ªÅn truy c·∫≠p.";
                    } else if (response.status === 429) {
                        errorMessage = "ƒê√£ h·∫øt l∆∞·ª£t s·ª≠ d·ª•ng API mi·ªÖn ph√≠. Vui l√≤ng th·ª≠ l·∫°i sau ho·∫∑c d√πng API key kh√°c.";
                    } else if (response.status === 500) {
                        errorMessage = "L·ªói server t·ª´ Google. Vui l√≤ng th·ª≠ l·∫°i sau.";
                    }
                    
                    throw new Error(errorMessage);
                }

                const result = await response.json();
                console.log('üìÑ Response data nh·∫≠n ƒë∆∞·ª£c');
                
                // X·ª≠ l√Ω response t·ª´ Gemini
                // Gemini c√≥ th·ªÉ tr·∫£ v·ªÅ text ho·∫∑c c·∫£ text v√† image
                const candidates = result.candidates;
                if (!candidates || candidates.length === 0) {
                    throw new Error("Kh√¥ng nh·∫≠n ƒë∆∞·ª£c k·∫øt qu·∫£ t·ª´ AI.");
                }

                const parts = candidates[0].content.parts;
                let generatedText = '';
                let imageBase64 = null;

                // T√¨m text v√† image trong response
                for (const part of parts) {
                    if (part.text) {
                        generatedText = part.text;
                    }
                    if (part.inlineData) {
                        imageBase64 = part.inlineData.data;
                    }
                }

                // N·∫øu c√≥ ·∫£nh trong response
                if (imageBase64) {
                    const imageUrl = `data:image/png;base64,${imageBase64}`;
                    currentTransformedImageUrl = imageUrl;
                    
                    // Hi·ªÉn th·ªã ·∫£nh
                    transformedImage.onload = function() {
                        console.log('‚úÖ ·∫¢nh ƒë√£ load th√†nh c√¥ng');
                    };
                    transformedImage.onerror = function() {
                        console.error('‚ùå L·ªói khi load ·∫£nh');
                        showMessage("L·ªói khi hi·ªÉn th·ªã ·∫£nh k·∫øt qu·∫£.", 'bg-red-100 text-red-800');
                    };
                    
                    transformedImage.src = imageUrl;
                    transformedImage.style.display = 'block';
                    placeholderText.style.display = 'none';
                    document.getElementById('downloadButton').disabled = false;
                    
                    showMessage("‚úÖ T·∫°o ·∫£nh th√†nh c√¥ng! B·∫°n c√≥ th·ªÉ t·∫£i v·ªÅ.", 'bg-green-100 text-green-800');
                    
                    // Hi·ªÉn th·ªã m√¥ t·∫£ n·∫øu c√≥
                    if (generatedText) {
                        console.log('üìù AI m√¥ t·∫£:', generatedText);
                    }
                } 
                // N·∫øu ch·ªâ c√≥ text (m·ªôt s·ªë model ch·ªâ tr·∫£ v·ªÅ text)
                else if (generatedText) {
                    console.log('üìù AI tr·∫£ v·ªÅ text:', generatedText);
                    showMessage(`‚ö†Ô∏è Model n√†y ch·ªâ tr·∫£ v·ªÅ text: "${generatedText.substring(0, 100)}..."`, 'bg-yellow-100 text-yellow-800');
                    showMessage("üí° Th·ª≠ ƒë·ªïi model trong code th√†nh 'gemini-1.5-pro' ho·∫∑c 'gemini-pro-vision'", 'bg-blue-100 text-blue-800');
                } 
                else {
                    throw new Error("API kh√¥ng tr·∫£ v·ªÅ ·∫£nh ho·∫∑c text. C√≥ th·ªÉ model kh√¥ng h·ªó tr·ª£ t·∫°o ·∫£nh.");
                }

            } catch (error) {
                console.error('‚ùå L·ªói khi t·∫°o ·∫£nh:', error);
                
                let errorMessage = error.message;
                
                // G·ª£i √Ω gi·∫£i ph√°p cho c√°c l·ªói ph·ªï bi·∫øn
                if (errorMessage.includes('h·∫øt l∆∞·ª£t') || errorMessage.includes('quota')) {
                    errorMessage += "\nüí° L·∫•y API key m·ªõi t·∫°i: https://makersuite.google.com/app/apikey";
                } else if (errorMessage.includes('API key')) {
                    errorMessage += "\nüí° Ki·ªÉm tra l·∫°i API key ho·∫∑c t·∫°o m·ªõi";
                } else if (errorMessage.includes('model')) {
                    errorMessage += "\nüí° Th·ª≠ ƒë·ªïi model trong code (d√≤ng const GEMINI_MODEL)";
                }
                
                showMessage(`‚ùå ${errorMessage}`, 'bg-red-100 text-red-800');
            } finally {
                setLoading(false);
            }
        }

        // ========== T·∫¢I ·∫¢NH V·ªÄ ==========
        function downloadImage() {
            if (!currentTransformedImageUrl) {
                showMessage("‚ùå Kh√¥ng c√≥ ·∫£nh ƒë·ªÉ t·∫£i v·ªÅ.", 'bg-red-100 text-red-800');
                return;
            }

            try {
                const link = document.createElement('a');
                link.href = currentTransformedImageUrl;
                
                // T·∫°o t√™n file v·ªõi timestamp
                const timestamp = new Date().getTime();
                const theme = document.getElementById('themeSelector').options[document.getElementById('themeSelector').selectedIndex].text;
                const safeTheme = theme.replace(/[^\w\s]/gi, '').substring(0, 20);
                link.download = `anh-bien-doi-${safeTheme}-${timestamp}.png`;
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showMessage("‚úÖ ƒêang t·∫£i ·∫£nh v·ªÅ... Ki·ªÉm tra th∆∞ m·ª•c Downloads c·ªßa b·∫°n.", 'bg-green-100 text-green-800');
            } catch (error) {
                console.error('L·ªói khi t·∫£i ·∫£nh:', error);
                showMessage("‚ùå L·ªói khi t·∫£i ·∫£nh. Vui l√≤ng th·ª≠ l·∫°i.", 'bg-red-100 text-red-800');
            }
        }

        // ========== H√ÄM TR·ª¢ GI√öP ==========
        function clearApiKey() {
            localStorage.removeItem('gemini_api_key');
            document.getElementById('apiKey').value = '';
            currentApiKey = '';
            checkReadyToGenerate();
            showMessage("‚úÖ ƒê√£ x√≥a API key kh·ªèi b·ªô nh·ªõ.", 'bg-green-100 text-green-800');
        }

        // ========== G√ÅN H√ÄM V√ÄO WINDOW ==========
        window.previewImage = previewImage;
        window.generateTransformedImage = generateTransformedImage;
        window.downloadImage = downloadImage;
        window.clearApiKey = clearApiKey;
    </script>
</body>

</html>
