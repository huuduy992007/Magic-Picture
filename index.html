<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nguy·ªÖn H·ªØu Duy - AI Image Transform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#4F46E5',
                        'secondary': '#10B981',
                        'background': '#F9FAFB',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        #fileInput { display: none; }
        .image-container { min-height: 256px; }
        .theme-select::-webkit-scrollbar { width: 8px; }
        .theme-select::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        .theme-select::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        .theme-select::-webkit-scrollbar-thumb:hover { background: #555; }
    </style>
</head>

<body class="bg-background min-h-screen font-sans antialiased p-4 sm:p-8">
    <div class="max-w-4xl mx-auto bg-white shadow-2xl rounded-xl p-6 sm:p-10">
        <header class="text-center mb-10">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-900 mb-2">üé® Bi·∫øn ƒê·ªïi ·∫¢nh C·ªßa B·∫°n V·ªõi AI</h1>
            <p class="text-gray-600 text-lg">T·∫£i l√™n ·∫£nh v√† ch·ªçn ch·ªß ƒë·ªÅ. Gemini AI s·∫Ω t·∫°o ra m·ªôt t√°c ph·∫©m ngh·ªá thu·∫≠t m·ªõi!</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-10">
            <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 flex flex-col items-center justify-center space-y-4 hover:border-primary transition duration-300">
                <label for="fileInput" class="cursor-pointer bg-primary text-white py-3 px-6 rounded-full font-semibold shadow-lg hover:bg-indigo-600 transition duration-300">Ch·ªçn ·∫¢nh T·∫£i L√™n</label>
                <input type="file" id="fileInput" accept="image/*">
                <p class="text-sm text-gray-500">T·∫£i l√™n ·∫£nh ƒë·ªãnh d·∫°ng JPG, JPEG ho·∫∑c PNG (t·ªëi ƒëa 5MB).</p>
                <div id="originalImageContainer" class="mt-4 w-full max-h-64 overflow-hidden rounded-lg border border-gray-200" style="display: none;">
                    <img id="originalImage" class="w-full h-auto object-contain max-h-64" alt="·∫¢nh g·ªëc">
                </div>
            </div>

            <div class="space-y-4">
                <label for="themeSelector" class="block text-xl font-bold text-gray-800">2. Ch·ªçn Ch·ªß ƒê·ªÅ Bi·∫øn ƒê·ªïi:</label>
                <select id="themeSelector" class="theme-select w-full p-3 border-2 border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition duration-300 text-gray-700 bg-white shadow-sm">
                    <option value="" disabled selected>-- Ch·ªçn m·ªôt phong c√°ch --</option>
                    <option value="Bi·∫øn ƒë·ªïi ho√†n to√†n th√†nh phong c√°ch Gi√°ng Sinh ·∫•m √°p, ƒë·∫ßy tuy·∫øt v√† √°nh ƒë√®n lung linh.">Gi√°ng Sinh üéÑ</option>
                    <option value="Bi·∫øn ƒë·ªïi ho√†n to√†n th√†nh phong c√°ch Halloween ma qu√°i, r√πng r·ª£n v·ªõi b√≠ ng√¥ v√† m√†u t·ªëi.">Halloween üéÉ</option>
                    <option value="Bi·∫øn ƒë·ªïi ho√†n to√†n th√†nh phong c√°ch T·∫øt Nguy√™n ƒê√°n r·ª±c r·ª°, v·ªõi hoa mai, hoa ƒë√†o, v√† kh√¥ng kh√≠ l·ªÖ h·ªôi truy·ªÅn th·ªëng.">T·∫øt Nguy√™n ƒê√°n üßß</option>
                    <option value="Bi·∫øn ƒë·ªïi ho√†n to√†n th√†nh phong c√°ch L·ªÖ h·ªôi M√πa H√® r·ª±c r·ª°, ƒë·∫ßy m√†u s·∫Øc, ph√°o hoa v√† √¢m nh·∫°c.">L·ªÖ h·ªôi M√πa H√® üéÜ</option>
                    <option value="Bi·∫øn ƒë·ªïi ho√†n to√†n th√†nh m·ªôt b·ª©c tranh phong c·∫£nh M√πa Thu l√£ng m·∫°n, v·ªõi l√° v√†ng, l√° ƒë·ªè.">Phong c·∫£nh M√πa Thu üçÇ</option>
                    <option value="Bi·∫øn ƒë·ªïi ho√†n to√†n th√†nh m·ªôt b·ª©c tranh phong c·∫£nh M√πa Xu√¢n t∆∞∆°i m·ªõi, v·ªõi c√¢y c·ªëi ƒë√¢m ch·ªìi n·∫£y l·ªôc v√† hoa n·ªü.">Phong c·∫£nh M√πa Xu√¢n üå∏</option>
                    <option value="Bi·∫øn ƒë·ªïi ho√†n to√†n th√†nh phong c√°ch thi·ªáp Ch√∫c M·ª´ng Sinh Nh·∫≠t, vui t∆∞∆°i v√† ƒë·∫ßy qu√† t·∫∑ng.">Sinh Nh·∫≠t üéÇ</option>
                    <option value="Bi·∫øn ƒë·ªïi ho√†n to√†n th√†nh phong c√°ch tranh s∆°n d·∫ßu tr·ª´u t∆∞·ª£ng, ƒë·∫ßy m√†u s·∫Øc v√† ƒë∆∞·ªùng n√©t m·∫°nh m·∫Ω.">Tranh S∆°n D·∫ßu Tr·ª´u T∆∞·ª£ng üé®</option>
                    <option value="Bi·∫øn ƒë·ªïi ho√†n to√†n th√†nh phong c√°ch ho·∫°t h√¨nh Nh·∫≠t B·∫£n (Anime) l√£ng m·∫°n, v·ªõi m√†u s·∫Øc t∆∞∆°i s√°ng v√† m·∫Øt to.">Phong c√°ch Anime üéå</option>
                </select>

                <button id="generateButton" class="w-full py-4 px-6 bg-secondary text-white font-bold rounded-xl shadow-xl hover:bg-emerald-600 transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center space-x-2">
                    <svg id="generateIcon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.05 15.54L10 13l-1.05 2.54M21 12a9 9 0 11-18 0 9 9 0 0118 0zM12 21a9 9 0 01-9-9 9 9 0 019-9 9 9 0 019 9 9 9 0 01-9 9zM12 12h.01"></path>
                    </svg>
                    <span id="generateText">T·∫°o ·∫¢nh Bi·∫øn ƒê·ªïi</span>
                    <svg id="loadingSpinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" style="display: none;">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </button>
            </div>
        </div>

        <div class="border-t border-gray-200 pt-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">3. K·∫øt Qu·∫£ Bi·∫øn ƒê·ªïi</h2>
            <div id="messageBox" class="text-center p-4 bg-blue-100 text-blue-800 rounded-lg mb-4" style="display: none;">·∫¢nh ƒë√£ s·∫µn s√†ng.</div>
            <div class="image-container w-full bg-gray-100 rounded-lg flex items-center justify-center p-4 shadow-inner">
                <img id="transformedImage" class="max-w-full h-auto max-h-96 rounded-lg shadow-xl" src="" alt="·∫¢nh ƒë√£ chuy·ªÉn ƒë·ªïi" style="display: none;">
                <p id="placeholderText" class="text-gray-500 italic">·∫¢nh k·∫øt qu·∫£ s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y sau khi b·∫°n t·∫°o.</p>
            </div>
            <div class="text-center mt-6">
                <button id="downloadButton" class="py-3 px-8 bg-primary text-white font-bold rounded-full shadow-lg hover:bg-indigo-600 transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed">T·∫£i ·∫¢nh V·ªÅ</button>
            </div>
        </div>

        <footer class="mt-10 pt-6 border-t border-gray-200 text-center text-sm text-gray-500">
            <p>·ª®ng d·ª•ng s·ª≠ d·ª•ng Google Gemini AI ƒë·ªÉ bi·∫øn ƒë·ªïi ·∫£nh.</p>
            <p class="mt-1">API Key ƒë√£ ƒë∆∞·ª£c t√≠ch h·ª£p s·∫µn.</p>
        </footer>
    </div>

    <script>
        const GEMINI_API_KEY = "AIzaSyA-ZoWBQSpOaZHJvnp0m2LwJgDA77x-cos";
        const GEMINI_MODEL = 'gemini-1.5-flash';
        const GEMINI_API_BASE = 'https://generativelanguage.googleapis.com/v1beta/models';
        
        let base64Image = null;
        let currentTransformedImageUrl = null;

        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Frontend ƒë√£ s·∫µn s√†ng');
            document.getElementById('fileInput').addEventListener('change', previewImage);
            document.getElementById('themeSelector').addEventListener('change', checkReadyToGenerate);
            document.getElementById('generateButton').addEventListener('click', generateTransformedImage);
            document.getElementById('downloadButton').addEventListener('click', downloadImage);
            showMessage("‚úÖ API Key ƒë√£ ƒë∆∞·ª£c t√≠ch h·ª£p s·∫µn. B·∫°n c√≥ th·ªÉ b·∫Øt ƒë·∫ßu s·ª≠ d·ª•ng!", 'bg-green-100 text-green-800');
        });

        function previewImage(event) {
            const file = event.target.files[0];
            const originalImage = document.getElementById('originalImage');
            const originalImageContainer = document.getElementById('originalImageContainer');
            const generateButton = document.getElementById('generateButton');

            base64Image = null;

            if (file) {
                if (file.size > 5 * 1024 * 1024) {
                    showMessage("‚ö†Ô∏è ·∫¢nh qu√° l·ªõn! Vui l√≤ng ch·ªçn ·∫£nh d∆∞·ªõi 5MB.", 'bg-red-100 text-red-800');
                    event.target.value = '';
                    return;
                }

                const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];
                if (!validTypes.includes(file.type)) {
                    showMessage("‚ùå Ch·ªâ ch·∫•p nh·∫≠n ·∫£nh JPG, JPEG ho·∫∑c PNG.", 'bg-red-100 text-red-800');
                    event.target.value = '';
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    originalImage.src = e.target.result;
                    originalImageContainer.style.display = 'block';
                    const base64Data = e.target.result.split(',')[1];
                    const mimeType = file.type;

                    if (base64Data) {
                        base64Image = { mimeType: mimeType, data: base64Data, fileName: file.name };
                        checkReadyToGenerate();
                        showMessage("‚úÖ ƒê√£ t·∫£i ·∫£nh th√†nh c√¥ng! Ch·ªçn ch·ªß ƒë·ªÅ ƒë·ªÉ ti·∫øp t·ª•c.", 'bg-green-100 text-green-800');
                    }
                };
                reader.onerror = function() {
                    showMessage("‚ùå L·ªói khi ƒë·ªçc file. Vui l√≤ng th·ª≠ l·∫°i.", 'bg-red-100 text-red-800');
                };
                reader.readAsDataURL(file);
            } else {
                originalImage.src = '';
                originalImageContainer.style.display = 'none';
                generateButton.disabled = true;
                showMessage("", 'bg-blue-100 text-blue-800');
            }
        }

        function checkReadyToGenerate() {
            const theme = document.getElementById('themeSelector').value;
            const generateButton = document.getElementById('generateButton');
            
            if (base64Image && theme) {
                generateButton.disabled = false;
                generateButton.classList.remove('disabled:opacity-50', 'disabled:cursor-not-allowed');
            } else {
                generateButton.disabled = true;
                generateButton.classList.add('disabled:opacity-50', 'disabled:cursor-not-allowed');
            }
        }

        function showMessage(message, classes = 'bg-blue-100 text-blue-800') {
            const box = document.getElementById('messageBox');
            if (!box) return;
            
            box.textContent = message;
            box.className = `text-center p-4 rounded-lg mb-4 ${classes}`;
            box.style.display = message ? 'block' : 'none';
            
            if (message && !classes.includes('red')) {
                setTimeout(() => {
                    if (box.textContent === message) {
                        box.style.display = 'none';
                    }
                }, 5000);
            }
        }

        function setLoading(isLoading) {
            const generateButton = document.getElementById('generateButton');
            const generateText = document.getElementById('generateText');
            const generateIcon = document.getElementById('generateIcon');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const downloadButton = document.getElementById('downloadButton');

            if (isLoading) {
                generateButton.disabled = true;
                generateText.textContent = 'ƒêang X·ª≠ L√Ω...';
                generateIcon.style.display = 'none';
                loadingSpinner.style.display = 'inline-block';
                downloadButton.disabled = true;
                showMessage("‚è≥ ƒêang g·ª≠i y√™u c·∫ßu ƒë·∫øn Gemini AI... Qu√° tr√¨nh c√≥ th·ªÉ m·∫•t 15-30 gi√¢y.", 'bg-yellow-100 text-yellow-800');
            } else {
                generateText.textContent = 'T·∫°o ·∫¢nh Bi·∫øn ƒê·ªïi';
                generateIcon.style.display = 'inline-block';
                loadingSpinner.style.display = 'none';
                checkReadyToGenerate();
            }
        }

        async function generateTransformedImage() {
            if (!base64Image) {
                showMessage("‚ùå Vui l√≤ng t·∫£i l√™n ·∫£nh tr∆∞·ªõc.", 'bg-red-100 text-red-800');
                return;
            }

            const themePrompt = document.getElementById('themeSelector').value;
            if (!themePrompt) {
                showMessage("‚ùå Vui l√≤ng ch·ªçn ch·ªß ƒë·ªÅ.", 'bg-red-100 text-red-800');
                return;
            }

            setLoading(true);
            
            const transformedImage = document.getElementById('transformedImage');
            const placeholderText = document.getElementById('placeholderText');
            transformedImage.style.display = 'none';
            placeholderText.style.display = 'block';
            document.getElementById('downloadButton').disabled = true;
            
            if (currentTransformedImageUrl) {
                URL.revokeObjectURL(currentTransformedImageUrl);
                currentTransformedImageUrl = null;
            }

            try {
                console.log('üîÑ ƒêang g·ª≠i request ƒë·∫øn Gemini API...');
                
                const userPrompt = `B·∫°n l√† m·ªôt ngh·ªá sƒ© AI chuy√™n nghi·ªáp. H√£y bi·∫øn ƒë·ªïi ho√†n to√†n ·∫£nh n√†y theo phong c√°ch sau: ${themePrompt}
                
                Y√äU C·∫¶U:
                1. Gi·ªØ nguy√™n b·ªë c·ª•c ch√≠nh v√† ch·ªß th·ªÉ c·ªßa ·∫£nh g·ªëc
                2. √Åp d·ª•ng phong c√°ch m·ªõi m·ªôt c√°ch tri·ªát ƒë·ªÉ v√† s√°ng t·∫°o
                3. ƒê·∫£m b·∫£o ch·∫•t l∆∞·ª£ng h√¨nh ·∫£nh cao, chi ti·∫øt r√µ r√†ng
                4. Kh√¥ng th√™m watermark, ch·ªØ k√Ω hay text
                5. T·∫°o ra m·ªôt t√°c ph·∫©m ngh·ªá thu·∫≠t ƒë·ªôc ƒë√°o v√† ƒë·∫πp m·∫Øt
                
                H√£y t·∫°o ra h√¨nh ·∫£nh bi·∫øn ƒë·ªïi v·ªõi ch·∫•t l∆∞·ª£ng cao nh·∫•t c√≥ th·ªÉ.`;

                const apiUrl = `${GEMINI_API_BASE}/${GEMINI_MODEL}:generateContent?key=${GEMINI_API_KEY}`;
                
                const payload = {
                    contents: [{
                        parts: [
                            { text: userPrompt },
                            { 
                                inlineData: {
                                    mimeType: base64Image.mimeType,
                                    data: base64Image.data
                                }
                            }
                        ]
                    }],
                    generationConfig: {
                        temperature: 0.7,
                        topP: 0.8,
                        topK: 40,
                        maxOutputTokens: 2048
                    }
                };

                console.log('üì§ G·ª≠i payload ƒë·∫øn Gemini API');
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                console.log(`üìä Response status: ${response.status}`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    let errorMessage = `L·ªói ${response.status}: ${errorText.substring(0, 200)}`;
                    
                    if (response.status === 400) {
                        errorMessage = "L·ªói request. Ki·ªÉm tra l·∫°i ƒë·ªãnh d·∫°ng ·∫£nh.";
                    } else if (response.status === 403) {
                        errorMessage = "API key kh√¥ng h·ª£p l·ªá ho·∫∑c kh√¥ng c√≥ quy·ªÅn truy c·∫≠p.";
                    } else if (response.status === 429) {
                        errorMessage = "ƒê√£ h·∫øt l∆∞·ª£t s·ª≠ d·ª•ng API mi·ªÖn ph√≠. Vui l√≤ng th·ª≠ l·∫°i sau.";
                    } else if (response.status === 500) {
                        errorMessage = "L·ªói server t·ª´ Google. Vui l√≤ng th·ª≠ l·∫°i sau.";
                    }
                    
                    throw new Error(errorMessage);
                }

                const result = await response.json();
                console.log('üìÑ Response data nh·∫≠n ƒë∆∞·ª£c');
                
                const candidates = result.candidates;
                if (!candidates || candidates.length === 0) {
                    throw new Error("Kh√¥ng nh·∫≠n ƒë∆∞·ª£c k·∫øt qu·∫£ t·ª´ AI.");
                }

                const parts = candidates[0].content.parts;
                let generatedText = '';
                let imageBase64 = null;

                for (const part of parts) {
                    if (part.text) {
                        generatedText = part.text;
                    }
                    if (part.inlineData) {
                        imageBase64 = part.inlineData.data;
                    }
                }

                if (imageBase64) {
                    const imageUrl = `data:image/png;base64,${imageBase64}`;
                    currentTransformedImageUrl = imageUrl;
                    
                    transformedImage.onload = function() {
                        console.log('‚úÖ ·∫¢nh ƒë√£ load th√†nh c√¥ng');
                    };
                    transformedImage.onerror = function() {
                        console.error('‚ùå L·ªói khi load ·∫£nh');
                        showMessage("L·ªói khi hi·ªÉn th·ªã ·∫£nh k·∫øt qu·∫£.", 'bg-red-100 text-red-800');
                    };
                    
                    transformedImage.src = imageUrl;
                    transformedImage.style.display = 'block';
                    placeholderText.style.display = 'none';
                    document.getElementById('downloadButton').disabled = false;
                    
                    showMessage("‚úÖ T·∫°o ·∫£nh th√†nh c√¥ng! B·∫°n c√≥ th·ªÉ t·∫£i v·ªÅ.", 'bg-green-100 text-green-800');
                    
                    if (generatedText) {
                        console.log('üìù AI m√¥ t·∫£:', generatedText);
                    }
                } 
                else if (generatedText) {
                    console.log('üìù AI tr·∫£ v·ªÅ text:', generatedText);
                    showMessage(`‚ö†Ô∏è Model n√†y ch·ªâ tr·∫£ v·ªÅ text: "${generatedText.substring(0, 100)}..."`, 'bg-yellow-100 text-yellow-800');
                } 
                else {
                    throw new Error("API kh√¥ng tr·∫£ v·ªÅ ·∫£nh ho·∫∑c text.");
                }

            } catch (error) {
                console.error('‚ùå L·ªói khi t·∫°o ·∫£nh:', error);
                showMessage(`‚ùå ${error.message}`, 'bg-red-100 text-red-800');
            } finally {
                setLoading(false);
            }
        }

        function downloadImage() {
            if (!currentTransformedImageUrl) {
                showMessage("‚ùå Kh√¥ng c√≥ ·∫£nh ƒë·ªÉ t·∫£i v·ªÅ.", 'bg-red-100 text-red-800');
                return;
            }

            try {
                const link = document.createElement('a');
                link.href = currentTransformedImageUrl;
                
                const timestamp = new Date().getTime();
                const theme = document.getElementById('themeSelector').options[document.getElementById('themeSelector').selectedIndex].text;
                const safeTheme = theme.replace(/[^\w\s]/gi, '').substring(0, 20);
                link.download = `anh-bien-doi-${safeTheme}-${timestamp}.png`;
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showMessage("‚úÖ ƒêang t·∫£i ·∫£nh v·ªÅ... Ki·ªÉm tra th∆∞ m·ª•c Downloads c·ªßa b·∫°n.", 'bg-green-100 text-green-800');
            } catch (error) {
                console.error('L·ªói khi t·∫£i ·∫£nh:', error);
                showMessage("‚ùå L·ªói khi t·∫£i ·∫£nh. Vui l√≤ng th·ª≠ l·∫°i.", 'bg-red-100 text-red-800');
            }
        }

        window.previewImage = previewImage;
        window.generateTransformedImage = generateTransformedImage;
        window.downloadImage = downloadImage;
    </script>
</body>
</html>
