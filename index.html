<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nguy·ªÖn H·ªØu Duy</title>
    <!-- T·∫£i Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- C·∫•u h√¨nh Tailwind cho font Inter v√† m√†u s·∫Øc -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#4F46E5', // Indigo
                        'secondary': '#10B981', // Emerald
                        'background': '#F9FAFB', // Light Gray background
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');

        /* ·∫®n input file m·∫∑c ƒë·ªãnh v√† t√πy ch·ªânh button */
        #fileInput {
            display: none;
        }

        /* T√πy ch·ªânh thanh cu·ªôn cho khu v·ª±c hi·ªÉn th·ªã ·∫£nh (t√πy ch·ªçn) */
        .image-container {
            min-height: 256px;
        }
    </style>
</head>

<body class="bg-background min-h-screen font-sans antialiased p-4 sm:p-8">

    <!-- Container Ch√≠nh -->
    <div class="max-w-4xl mx-auto bg-white shadow-2xl rounded-xl p-6 sm:p-10">

        <!-- Ti√™u ƒë·ªÅ v√† H∆∞·ªõng d·∫´n -->
        <header class="text-center mb-10">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-900 mb-2">
                üé® Bi·∫øn ƒê·ªïi ·∫¢nh C·ªßa B·∫°n V·ªõi AI
            </h1>
            <p class="text-gray-600 text-lg">
                T·∫£i l√™n ·∫£nh v√† ch·ªçn ch·ªß ƒë·ªÅ. Gemini AI s·∫Ω t·∫°o ra m·ªôt t√°c ph·∫©m ngh·ªá thu·∫≠t m·ªõi!
            </p>
        </header>

        <!-- Khu v·ª±c 1: T·∫£i ·∫£nh v√† L·ª±a ch·ªçn ch·ªß ƒë·ªÅ -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-10">

            <!-- T·∫£i ·∫£nh l√™n -->
            <div
                class="border-2 border-dashed border-gray-300 rounded-lg p-6 flex flex-col items-center justify-center space-y-4 hover:border-primary transition duration-300">
                <label for="fileInput"
                    class="cursor-pointer bg-primary text-white py-3 px-6 rounded-full font-semibold shadow-lg hover:bg-indigo-600 transition duration-300">
                    Ch·ªçn ·∫¢nh T·∫£i L√™n
                </label>
                <input type="file" id="fileInput" accept="image/*" onchange="previewImage(event)">
                <p class="text-sm text-gray-500">T·∫£i l√™n ·∫£nh ƒë·ªãnh d·∫°ng JPG ho·∫∑c PNG.</p>

                <!-- Xem tr∆∞·ªõc ·∫£nh g·ªëc -->
                <div id="originalImageContainer"
                    class="mt-4 w-full max-h-64 overflow-hidden rounded-lg border border-gray-200"
                    style="display: none;">
                    <img id="originalImage" class="w-full h-auto object-contain max-h-64" alt="·∫¢nh g·ªëc">
                </div>
            </div>

            <!-- L·ª±a ch·ªçn ch·ªß ƒë·ªÅ -->
            <div class="space-y-4">
                <label for="themeSelector" class="block text-xl font-bold text-gray-800">2. Ch·ªçn Ch·ªß ƒê·ªÅ Bi·∫øn
                    ƒê·ªïi:</label>
                <select id="themeSelector"
                    class="w-full p-3 border-2 border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition duration-300 text-gray-700 bg-white shadow-sm">
                    <option value="" disabled selected>-- Ch·ªçn m·ªôt phong c√°ch --</option>
                    <option
                        value="Bi·∫øn ƒë·ªïi ho√†n to√†n th√†nh phong c√°ch Gi√°ng Sinh ·∫•m √°p, ƒë·∫ßy tuy·∫øt v√† √°nh ƒë√®n lung linh.">
                        Gi√°ng Sinh üéÑ</option>
                    <option
                        value="Bi·∫øn ƒë·ªïi ho√†n to√†n th√†nh phong c√°ch Halloween ma qu√°i, r√πng r·ª£n v·ªõi b√≠ ng√¥ v√† m√†u t·ªëi.">
                        Halloween üéÉ</option>
                    <option
                        value="Bi·∫øn ƒë·ªïi ho√†n to√†n th√†nh phong c√°ch T·∫øt Nguy√™n ƒê√°n r·ª±c r·ª°, v·ªõi hoa mai, hoa ƒë√†o, v√† kh√¥ng kh√≠ l·ªÖ h·ªôi truy·ªÅn th·ªëng.">
                        T·∫øt Nguy√™n ƒê√°n üßß</option>
                    <option
                        value="Bi·∫øn ƒë·ªïi ho√†n to√†n th√†nh phong c√°ch L·ªÖ h·ªôi M√πa H√® r·ª±c r·ª°, ƒë·∫ßy m√†u s·∫Øc, ph√°o hoa v√† √¢m nh·∫°c.">
                        L·ªÖ h·ªôi M√πa H√® üéÜ</option>
                    <option
                        value="Bi·∫øn ƒë·ªïi ho√†n to√†n th√†nh m·ªôt b·ª©c tranh phong c·∫£nh M√πa Thu l√£ng m·∫°n, v·ªõi l√° v√†ng, l√° ƒë·ªè.">
                        Phong c·∫£nh M√πa Thu üçÇ</option>
                    <option
                        value="Bi·∫øn ƒë·ªïi ho√†n to√†n th√†nh m·ªôt b·ª©c tranh phong c·∫£nh M√πa Xu√¢n t∆∞∆°i m·ªõi, v·ªõi c√¢y c·ªëi ƒë√¢m ch·ªìi n·∫£y l·ªôc v√† hoa n·ªü.">
                        Phong c·∫£nh M√πa Xu√¢n üå∏</option>
                    <option
                        value="Bi·∫øn ƒë·ªïi ho√†n to√†n th√†nh phong c√°ch thi·ªáp Ch√∫c M·ª´ng Sinh Nh·∫≠t, vui t∆∞∆°i v√† ƒë·∫ßy qu√† t·∫∑ng.">
                        Sinh Nh·∫≠t üéÇ</option>
                    <option
                        value="Bi·∫øn ƒë·ªïi ho√†n to√†n th√†nh phong c√°ch tranh s∆°n d·∫ßu tr·ª´u t∆∞·ª£ng, ƒë·∫ßy m√†u s·∫Øc v√† ƒë∆∞·ªùng n√©t m·∫°nh m·∫Ω.">
                        Tranh S∆°n D·∫ßu Tr·ª´u T∆∞·ª£ng üé®</option>
                    <option
                        value="Bi·∫øn ƒë·ªïi ho√†n to√†n th√†nh phong c√°ch ho·∫°t h√¨nh Nh·∫≠t B·∫£n (Anime) l√£ng m·∫°n, v·ªõi m√†u s·∫Øc t∆∞∆°i s√°ng v√† m·∫Øt to.">
                        Phong c√°ch Anime üéå</option>
                </select>

                <!-- N√∫t X·ª≠ l√Ω -->
                <button id="generateButton" onclick="generateTransformedImage()" disabled
                    class="w-full py-4 px-6 bg-secondary text-white font-bold rounded-xl shadow-xl hover:bg-emerald-600 transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center space-x-2">
                    <svg id="generateIcon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                        xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M11.05 15.54L10 13l-1.05 2.54M21 12a9 9 0 11-18 0 9 9 0 0118 0zM12 21a9 9 0 01-9-9 9 9 0 019-9 9 9 0 019 9 9 9 0 01-9 9zM12 12h.01">
                        </path>
                    </svg>
                    <span id="generateText">T·∫°o ·∫¢nh Bi·∫øn ƒê·ªïi</span>
                    <svg id="loadingSpinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white"
                        xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" style="display: none;">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4">
                        </circle>
                        <path class="opacity-75" fill="currentColor"
                            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                        </path>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Khu v·ª±c 2: Hi·ªÉn th·ªã k·∫øt qu·∫£ v√† T·∫£i v·ªÅ -->
        <div class="border-t border-gray-200 pt-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">3. K·∫øt Qu·∫£ Bi·∫øn ƒê·ªïi</h2>

            <!-- Hi·ªÉn th·ªã th√¥ng b√°o/loading -->
            <div id="messageBox" class="text-center p-4 bg-blue-100 text-blue-800 rounded-lg mb-4"
                style="display: none;">
                ·∫¢nh ƒë√£ s·∫µn s√†ng.
            </div>

            <!-- Container cho ·∫£nh k·∫øt qu·∫£ -->
            <div
                class="image-container w-full bg-gray-100 rounded-lg flex items-center justify-center p-4 shadow-inner">
                <img id="transformedImage" class="max-w-full h-auto max-h-96 rounded-lg shadow-xl" src=""
                    alt="·∫¢nh ƒë√£ chuy·ªÉn ƒë·ªïi" style="display: none;">
                <p id="placeholderText" class="text-gray-500 italic">
                    ·∫¢nh k·∫øt qu·∫£ s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y sau khi b·∫°n t·∫°o.
                </p>
            </div>

            <!-- N√∫t T·∫£i v·ªÅ -->
            <div class="text-center mt-6">
                <button id="downloadButton" onclick="downloadImage()" disabled
                    class="py-3 px-8 bg-primary text-white font-bold rounded-full shadow-lg hover:bg-indigo-600 transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed">
                    T·∫£i ·∫¢nh V·ªÅ
                </button>
            </div>
        </div>

    </div>

    <script type="module">
        // Khai b√°o bi·∫øn to√†n c·ª•c t·ª´ m√¥i tr∆∞·ªùng Canvas (B·∫ÆT BU·ªòC)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const apiKey = ""; // API key ƒë∆∞·ª£c cung c·∫•p t·ª± ƒë·ªông b·ªüi Canvas
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`;

        let base64Image = null;

        // --- H√ÄM X·ª¨ L√ù GIAO DI·ªÜN V√Ä FILE ---

        /**
         * Chuy·ªÉn ƒë·ªïi file ·∫£nh ƒë√£ ch·ªçn th√†nh Base64 ƒë·ªÉ g·ª≠i l√™n API.
         * @param {Event} event S·ª± ki·ªán thay ƒë·ªïi c·ªßa input file.
         */
        window.previewImage = function (event) {
            const file = event.target.files[0];
            const originalImage = document.getElementById('originalImage');
            const originalImageContainer = document.getElementById('originalImageContainer');
            const generateButton = document.getElementById('generateButton');

            base64Image = null; // Reset Base64

            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    // C·∫≠p nh·∫≠t ·∫£nh xem tr∆∞·ªõc
                    originalImage.src = e.target.result;
                    originalImageContainer.style.display = 'block';

                    // L·∫•y ph·∫ßn Base64 data (sau d·∫•u ph·∫©y)
                    const base64Data = e.target.result.split(',')[1];
                    const mimeType = file.type;

                    if (base64Data) {
                        base64Image = {
                            mimeType: mimeType,
                            data: base64Data
                        };
                        // K√≠ch ho·∫°t n√∫t t·∫°o ·∫£nh n·∫øu ƒë√£ c√≥ ·∫£nh v√† ƒë√£ ch·ªçn ch·ªß ƒë·ªÅ
                        checkReadyToGenerate();
                    } else {
                        showMessage("L·ªói: Kh√¥ng th·ªÉ ƒë·ªçc d·ªØ li·ªáu ·∫£nh Base64.", 'bg-red-100 text-red-800');
                        generateButton.disabled = true;
                    }
                };
                reader.readAsDataURL(file);
            } else {
                originalImage.src = '';
                originalImageContainer.style.display = 'none';
                generateButton.disabled = true;
            }
        };

        // L·∫Øng nghe s·ª± ki·ªán thay ƒë·ªïi c·ªßa selector ƒë·ªÉ k√≠ch ho·∫°t n√∫t t·∫°o ·∫£nh
        document.getElementById('themeSelector').addEventListener('change', checkReadyToGenerate);

        /**
         * Ki·ªÉm tra ƒëi·ªÅu ki·ªán ƒë·ªÉ k√≠ch ho·∫°t n√∫t t·∫°o ·∫£nh.
         */
        function checkReadyToGenerate() {
            const theme = document.getElementById('themeSelector').value;
            const generateButton = document.getElementById('generateButton');
            if (base64Image && theme) {
                generateButton.disabled = false;
            } else {
                generateButton.disabled = true;
            }
        }

        /**
         * Hi·ªÉn th·ªã th√¥ng b√°o.
         * @param {string} message N·ªôi dung th√¥ng b√°o.
         * @param {string} classes L·ªõp CSS cho m√†u s·∫Øc/n·ªÅn.
         */
        function showMessage(message, classes = 'bg-blue-100 text-blue-800') {
            const box = document.getElementById('messageBox');
            box.textContent = message;
            box.className = `text-center p-4 rounded-lg mb-4 ${classes}`;
            box.style.display = 'block';
        }

        /**
         * C·∫≠p nh·∫≠t tr·∫°ng th√°i loading.
         * @param {boolean} isLoading Tr·∫°ng th√°i loading (true/false).
         */
        function setLoading(isLoading) {
            const generateButton = document.getElementById('generateButton');
            const generateText = document.getElementById('generateText');
            const generateIcon = document.getElementById('generateIcon');
            const loadingSpinner = document.getElementById('loadingSpinner');

            generateButton.disabled = isLoading;
            if (isLoading) {
                generateText.textContent = 'ƒêang X·ª≠ L√Ω...';
                generateIcon.style.display = 'none';
                loadingSpinner.style.display = 'inline-block';
                generateButton.classList.remove('bg-secondary', 'hover:bg-emerald-600');
                generateButton.classList.add('bg-gray-500');
                showMessage("ƒêang g·ª≠i y√™u c·∫ßu ƒë·∫øn AI ƒë·ªÉ t·∫°o ·∫£nh. Qu√° tr√¨nh n√†y c√≥ th·ªÉ m·∫•t v√†i gi√¢y...", 'bg-yellow-100 text-yellow-800');
            } else {
                generateText.textContent = 'T·∫°o ·∫¢nh Bi·∫øn ƒê·ªïi';
                generateIcon.style.display = 'inline-block';
                loadingSpinner.style.display = 'none';
                generateButton.classList.add('bg-secondary', 'hover:bg-emerald-600');
                generateButton.classList.remove('bg-gray-500');
            }
        }

        // --- H√ÄM G·ªåI API GEMINI ---

        /**
         * Th·ª±c hi·ªán cu·ªôc g·ªçi API ƒë·ªÉ chuy·ªÉn ƒë·ªïi ·∫£nh.
         */
        window.generateTransformedImage = async function () {
            if (!base64Image) {
                showMessage("Vui l√≤ng t·∫£i l√™n m·ªôt ·∫£nh tr∆∞·ªõc.", 'bg-red-100 text-red-800');
                return;
            }

            const themePrompt = document.getElementById('themeSelector').value;
            if (!themePrompt) {
                showMessage("Vui l√≤ng ch·ªçn m·ªôt ch·ªß ƒë·ªÅ bi·∫øn ƒë·ªïi.", 'bg-red-100 text-red-800');
                return;
            }

            setLoading(true);
            document.getElementById('downloadButton').disabled = true;
            document.getElementById('transformedImage').style.display = 'none';
            document.getElementById('placeholderText').style.display = 'block';

            // X√¢y d·ª±ng prompt ƒë·ªÉ h∆∞·ªõng d·∫´n m√¥ h√¨nh AI chuy·ªÉn ƒë·ªïi ·∫£nh
            const userPrompt = `D·ª±a tr√™n ·∫£nh ƒë√£ cung c·∫•p, h√£y bi·∫øn ƒë·ªïi ·∫£nh ƒê·∫¶Y ƒê·ª¶ v√† HO√ÄN TO√ÄN th√†nh phong c√°ch sau. ${themePrompt}. ƒê·∫£m b·∫£o ch·∫•t l∆∞·ª£ng ngh·ªá thu·∫≠t cao, chi ti·∫øt, v√† gi·ªØ l·∫°i b·ªë c·ª•c t·ªïng th·ªÉ c·ªßa ·∫£nh g·ªëc nh∆∞ng √°p d·ª•ng tri·ªát ƒë·ªÉ phong c√°ch m·ªõi.`;

            const payload = {
                contents: [{
                    parts: [
                        { text: userPrompt }, // Prompt m√¥ t·∫£ vi·ªác chuy·ªÉn ƒë·ªïi
                        { inlineData: base64Image } // D·ªØ li·ªáu ·∫£nh ƒë·∫ßu v√†o
                    ]
                }],
                generationConfig: {
                    responseModalities: ['TEXT', 'IMAGE'] // Y√™u c·∫ßu tr·∫£ v·ªÅ c·∫£ vƒÉn b·∫£n (m·∫∑c ƒë·ªãnh) v√† h√¨nh ·∫£nh
                },
                // Model: gemini-2.5-flash-image-preview
            };

            // H√†m retry v·ªõi exponential backoff
            const maxRetries = 3;
            let lastError = null;

            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        // FIX: Lo·∫°i b·ªè k√Ω t·ª± escape kh√¥ng c·∫ßn thi·∫øt trong template literal
                        throw new Error(`L·ªói HTTP: ${response.status}`);
                    }

                    const result = await response.json();

                    const base64Data = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;

                    if (base64Data) {
                        // FIX: Lo·∫°i b·ªè k√Ω t·ª± escape kh√¥ng c·∫ßn thi·∫øt trong template literal
                        const imageUrl = `data:image/png;base64,${base64Data}`;
                        const transformedImage = document.getElementById('transformedImage');

                        // Hi·ªÉn th·ªã ·∫£nh k·∫øt qu·∫£
                        transformedImage.src = imageUrl;
                        transformedImage.style.display = 'block';
                        document.getElementById('placeholderText').style.display = 'none';
                        document.getElementById('downloadButton').disabled = false;
                        showMessage("‚úÖ Chuy·ªÉn ƒë·ªïi th√†nh c√¥ng! ·∫¢nh ƒë√£ s·∫µn s√†ng.", 'bg-green-100 text-green-800');
                        break; // Th√†nh c√¥ng, tho√°t v√≤ng l·∫∑p
                    } else {
                        // Tr∆∞·ªùng h·ª£p API tr·∫£ v·ªÅ th√†nh c√¥ng nh∆∞ng kh√¥ng c√≥ ·∫£nh (hi·∫øm)
                        throw new Error("API kh√¥ng tr·∫£ v·ªÅ d·ªØ li·ªáu ·∫£nh h·ª£p l·ªá.");
                    }

                } catch (error) {
                    lastError = error;
                    console.error(`Th·ª≠ l·∫°i l·∫ßn ${attempt + 1} th·∫•t b·∫°i:`, error);
                    if (attempt < maxRetries - 1) {
                        const delay = Math.pow(2, attempt) * 1000; // 1s, 2s, 4s
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
            }

            setLoading(false);

            if (lastError && document.getElementById('transformedImage').style.display === 'none') {
                // FIX: Lo·∫°i b·ªè k√Ω t·ª± escape kh√¥ng c·∫ßn thi·∫øt trong template literal
                showMessage(`L·ªói trong qu√° tr√¨nh t·∫°o ·∫£nh. Vui l√≤ng th·ª≠ l·∫°i. Chi ti·∫øt: ${lastError.message || 'Kh√¥ng r√µ l·ªói.'}`, 'bg-red-100 text-red-800');
            }
        };

        // --- H√ÄM T·∫¢I ·∫¢NH XU·ªêNG ---

        /**
         * T·∫£i ·∫£nh ƒë√£ ƒë∆∞·ª£c chuy·ªÉn ƒë·ªïi v·ªÅ m√°y.
         */
        window.downloadImage = function () {
            const imageElement = document.getElementById('transformedImage');
            const imageUrl = imageElement.src;

            if (imageUrl && imageUrl !== '#') {
                const link = document.createElement('a');
                link.href = imageUrl;
                // ƒê·∫∑t t√™n file t·∫£i v·ªÅ
                link.download = 'anh-chuyen-doi-gemini.png';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } else {
                showMessage("Kh√¥ng c√≥ ·∫£nh ƒë·ªÉ t·∫£i v·ªÅ. Vui l√≤ng t·∫°o ·∫£nh tr∆∞·ªõc.", 'bg-red-100 text-red-800');
            }
        };
    </script>
</body>

</html>
